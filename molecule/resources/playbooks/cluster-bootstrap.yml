---

- hosts: all
  vars:
    homecloud_ceph_monitor_ips_as_array: "{{ groups.ceph_mon | default([]) | map('extract', hostvars, ['homecloud_node_ip']) | list }}"
    homecloud_ceph_monitor_ips: "{{ homecloud_ceph_monitor_ips_as_array | join(',') }}"
    homecloud_ceph_is_enabled: "{{ homecloud_ceph_monitor_ips | length > 0 }}"
  pre_tasks:
    - include_role: name="resources_prepare"
  tasks:
    # CLUSTER
    - include_role:
        name: cluster_node
    # DNAS
    - name: Bootstrap dnas services
      include_role:
        name: "{{ dnas_service }}"
      loop: "{{ dnas_services | default([]) }}"
      loop_control:
        loop_var: "dnas_service"
    # SWARM
    - name: Bootstrap swarm services
      include_role:
        name: "{{ swarm_service }}"
      loop: "{{ swarm_services | default([]) }}"
      loop_control:
        loop_var: "swarm_service"
    # K3S
    - name: Bootstrap k3s services
      include_role:
        name: "{{ k3s_service }}"
      loop: "{{ k3s_services | default([]) }}"
      loop_control:
        loop_var: "k3s_service"
    # CEPH
    - name: Bootstrap ceph services
      include_role:
        name: "{{ ceph_service }}"
      loop: "{{ ceph_services | default([]) }}"
      loop_control:
        loop_var: "ceph_service"
  post_tasks:
    - include_role: name="resources_clean"
