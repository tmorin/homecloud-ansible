---

- hosts: swarm_mgr[0]
  tasks:
    - name: "wait for {{ verify_waitfor_stack }} - {{ verify_waitfor_service }}"
      become: yes
      shell: |
        set -e -o pipefail
        stack="{{ verify_waitfor_stack }}"
        service="{{ verify_waitfor_service }}"
        until [[ ! -z "$(grep -Eo "${service} Running" /tmp/test)" ]]; do
          echo "wait for the ${service} service" && sleep 1
          docker stack ps ${stack} --format='{{ '{{' }}.Name{{ '}} '}}{{ '{{' }}.CurrentState{{ '}}' }}' > /tmp/test
        done
      args:
        executable: /bin/bash
