---

- name: Cleaning existing deployment
  shell: |
    docker kill keepalived || true
    docker rm keepalived || true
    docker rmi {{ service_keepalived_image }} || true
  changed_when: false

- name: Pull an image
  community.docker.docker_image:
    name: "{{ service_keepalived_image }}"
    source: pull
  changed_when: false

- name: Deploy container
  community.docker.docker_container:
    networks_cli_compatible: yes
    container_default_behavior: no_defaults
    name: keepalived
    image: '{{ service_keepalived_image }}'
    detach: yes
    state: started
    restart_policy: unless-stopped
    network_mode: host
    networks:
      - name: host
    capabilities:
      - NET_ADMIN
    env:
      KEEPALIVED_INTERFACE: "{{ service_keepalived_interface | default('') }}"
      KEEPALIVED_PASSWORD: "{{ service_keepalived_password | default('') }}"
      KEEPALIVED_ROUTER_ID: "{{ service_keepalived_router_id | default('') }}"
      KEEPALIVED_NOTIFY: "{{ service_keepalived_notify | default('') }}"
      KEEPALIVED_PRIORITY: "{{ (groups['swarm_mgr'][0] == inventory_hostname) | ternary('200','100') }}"
      KEEPALIVED_VIRTUAL_IPS: "{{ homecloud_virtual_ip }}"
      KEEPALIVED_UNICAST_PEERS: "{{ homecloud_ips_as_strings }}"
  changed_when: false
