---

- name: Create the vault directory
  delegate_to: localhost
  file:
    path: "{{ homecloud_vault_path }}"
    state: directory
    mode: 0755

- name: Install dependencies
  when: inventory_hostname in groups.ceph
  become: true
  package:
    name: curl,lvm2
    state: present
    force_apt_get: "yes"

- name: Install cephadm
  when: inventory_hostname in groups.ceph_mon
  import_tasks: install-cephadm.yml

- name: Setup the main manager node
  when: inventory_hostname in groups.ceph_mon[0:1]
  block:
    - name: Initialize cluster
      import_tasks: initialize-cluster.yml
    - name: Get ssh pubkey
      import_tasks: get-ssh-pubkey.yml
    - name: Get ceph client secret
      import_tasks: get-ceph-client-secret.yml
    - name: Configure cluster
      import_tasks: configure-cluster.yml

- name: Populate remaining hosts
  when: inventory_hostname in groups.ceph
  block:
    - import_tasks: push-ssh-pubkey.yml

- name: Setup the other nodes
  when: inventory_hostname in groups.ceph_mon[0:1]
  block:
    - name: Add hosts
      import_tasks: add-hosts.yml
    - name: Add osds
      import_tasks: add-osds.yml
    - name: Create volumes
      import_tasks: create-volumes.yml

- name: Install Docker plugin
  when: inventory_hostname in groups.ceph+(groups.swarm | default([]) )
  import_tasks: install-docker-plugin.yml
