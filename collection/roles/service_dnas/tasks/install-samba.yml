---

- name: Install samba
  become: true
  package:
    name: samba
    state: present
    force_apt_get: true

- name: Acviate and start smbd.service
  become: true
  systemd:
    daemon_reload: true
    name: smbd.service
    enabled: true
    state: started
  changed_when: false

- name: Stop smbd service
  become: true
  systemd:
    name: smbd.service
    state: stopped
  changed_when: false

- name: Copy smb.conf
  become: true
  template:
    src: smb.conf.jinja2
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: 0644

- name: Set samba password
  become: true
  shell: |
    set -o pipefail
    (pdbedit --user={{ service_dnas_username }} &>/dev/null) \
    || (echo '{{ service_dnas_username }}'; echo '{{ service_dnas_username }}') \
    | smbpasswd -s -a {{ service_dnas_username }}
  args:
    executable: /bin/bash
  changed_when: false

- name: Restart smbd.service
  become: true
  service:
    name: smbd.service
    state: restarted
  changed_when: false
