---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: calibreweb
  namespace: default
spec:
  repo: https://k8s-at-home.com/charts
  chart: calibre-web
  valuesContent: |-
    env:
      PGID: "33"
      PUID: "33"
      {% if k3s_calibreweb_server_timezone | default(false) -%}
      SET_CONTAINER_TIMEZONE: "true"
      CONTAINER_TIMEZONE: {{ k3s_calibreweb_server_timezone }}
      {%- endif %}

    persistence:
      config:
        enabled: true
        mountPath: /config
        {% if k3s_calibreweb_config_existing_claim | default(false) -%}
        existingClaim: "{{ k3s_calibreweb_config_existing_claim }}"
        {% else -%}
        storageClass: "{{ k3s_calibreweb_config_storage_class }}"
        size: "{{ k3s_calibreweb_config_storage_size }}"
        accessMode: "ReadWriteOnce"
        {%- endif %}

      books:
        enabled: true
        mountPath: /books
        {% if k3s_calibreweb_book_existing_claim | default(false) -%}
        existingClaim: "{{ k3s_calibreweb_book_existing_claim }}"
        {% else -%}
        storageClass: "{{ k3s_calibreweb_book_storage_class }}"
        size: "{{ k3s_calibreweb_book_storage_size }}"
        accessMode: "ReadWriteOnce"
        {%- endif %}

    resources:
      limits:
        memory: "{{ k3s_calibreweb_resource_memory }}"
      requests:
        memory: "{{ k3s_calibreweb_resource_memory }}"
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: calibreweb
  namespace: default
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`{{ k3s_calibreweb_ingress_host }}`)
      kind: Rule
      services:
        - name: calibreweb-calibre-web
          port: 8083
---
# curl -IkH host:calibreweb.home.cloud http://localhost:32080
# curl -IkH host:calibreweb.home.cloud https://localhost:32443
