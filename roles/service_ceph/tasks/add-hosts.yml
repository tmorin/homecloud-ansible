---

- name: Add the monitors to the ceph cluster
  become: yes
  shell: |
    set -exo pipefail
    status=$(cephadm shell -- ceph orch host ls | grep "{{ item }}" && echo "Exist" || echo "Missing")
    if [[ "$status" == "Missing" ]]; then
      cephadm shell -- ceph orch host add {{ item }} {{ hostvars[item].homecloud_node_ip }} \
      || exit 1
    fi
    cephadm shell -- ceph orch host label add {{ item }} mon
  args:
    executable: /bin/bash
  loop: "{{ groups.ceph_mon | default([]) }}"
  register: add_hosts
  changed_when: false

- name: Add managers to the ceph cluster
  become: yes
  shell: |
    set -exo pipefail
    status=$(cephadm shell -- ceph orch host ls | grep "{{ item }}" && echo "Exist" || echo "Missing")
    if [[ "$status" == "Missing" ]]; then
      cephadm shell -- ceph orch host add {{ item }} {{ hostvars[item].homecloud_node_ip }} \
      || exit 1
    fi
    cephadm shell -- ceph orch host label add {{ item }} mgr
  args:
    executable: /bin/bash
  loop: "{{ groups.ceph_mgr | default([]) }}"
  register: add_hosts
  changed_when: false

- name: Add the osd to the ceph cluster
  become: yes
  shell: |
    set -exo pipefail
    status=$(cephadm shell -- ceph orch host ls | grep "{{ item }}" && echo "Exist" || echo "Missing")
    if [[ "$status" == "Missing" ]]; then
      cephadm shell -- ceph orch host add {{ item }} {{ hostvars[item].homecloud_node_ip }} \
      || exit 1
    fi
    cephadm shell -- ceph orch host label add {{ item }} osd
  args:
    executable: /bin/bash
  loop: "{{ groups.ceph_osd | default([]) }}"
  register: add_hosts
  changed_when: false

- name: Deploy mgr and mon
  become: yes
  shell: |
    set -exo pipefail
    cephadm shell -- ceph orch apply mgr label:mgr
    cephadm shell -- ceph orch apply mon label:mon
  args:
    executable: /bin/bash
  register: add_hosts
  changed_when: false
