---

- name: Create the vault directory
  delegate_to: localhost
  file:
    path: "{{ homecloud_vault_path }}"
    state: directory

- name: Install cephadm
  import_tasks: install-cephadm.yml

- name: Setup the main manager node
  when: inventory_hostname in groups.ceph_mon[0:1]
  block:
    - name: 'initialize cluster'
      import_tasks: initialize-cluster.yml
    - name: 'get ssh pubkey'
      import_tasks: get-ssh-pubkey.yml
    - name: 'get ceph client secret'
      import_tasks: get-ceph-client-secret.yml
    - name: 'configure cluster'
      import_tasks: configure-cluster.yml

- name: Populate remaining hosts
  when: inventory_hostname in groups.ceph_mgr,groups.ceph_mon,groups.ceph_osd
  block:
    - import_tasks: push-ssh-pubkey.yml

- name: Setup the other nodes
  when: inventory_hostname in groups.ceph_mon[0:1]
  block:
    - name: 'add hosts'
      import_tasks: add-hosts.yml
    - name: 'add osds'
      import_tasks: add-osds.yml
    - name: 'create volumes'
      import_tasks: create-volumes.yml
