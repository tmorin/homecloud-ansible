---

- name: 'add osds'
  shell: |
    status=$(cephadm shell -- ceph orch device ls {{ item }} --refresh |  grep "{{ hostvars[item].ceph_osd_device }}")
    echo "1 status $status"
    until [[ ! -z "$status" ]]; do
      sleep 1
      status=$(cephadm shell -- ceph orch device ls {{ item }} --refresh |  grep "{{ hostvars[item].ceph_osd_device }}")
      echo "2 status loop $status"
    done
    status=$(cephadm shell -- ceph orch device ls {{ item }} --refresh |  grep "{{ hostvars[item].ceph_osd_device }}" | awk '{print $6}')
    if [[ "$status" == "True" ]]; then
      cephadm shell -- ceph orch daemon add osd {{ item }}:{{ hostvars[item].ceph_osd_device }}
      if [[ ! $? -eq 0 ]]; then
        exit 1
      fi
      until [[ "$status" == "True" ]]; do
        status=$(cephadm shell -- ceph orch device ls {{ item }} --refresh |  grep "{{ hostvars[item].ceph_osd_device }}" | awk '{print $6}')
        sleep 1
        echo "3 status loop $status"
      done
    fi
  args:
    executable: /bin/bash
  loop: "{{ groups.swarm }}"
  register: add_osds

- debug: var=add_osds
