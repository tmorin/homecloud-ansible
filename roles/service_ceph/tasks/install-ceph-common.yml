---

- name: 'get ceph configuration'
  when: inventory_hostname in groups.ceph_mon[0:1]
  become: yes
  fetch:
    src: "/etc/ceph/ceph.conf"
    dest: "{{ playbook_dir }}/vault/ceph.conf"
    flat: yes
  register: install_ceph_common

- name: 'create ceph directory'
  become: yes
  when: inventory_hostname not in groups.ceph_mon[0:1]
  file:
    path: "/etc/ceph"
    state: directory
  register: install_ceph_common

- name: 'push ceph configuration'
  when: inventory_hostname not in groups.ceph_mon[0:1]
  become: yes
  copy:
    src: "{{ playbook_dir }}/vault/ceph.conf"
    dest: "/etc/ceph/ceph.conf"
    force: true
  register: install_ceph_common

- name: 'install ceph-common'
  become: yes
  shell: |
    set -exo pipefail
    cephadm add-repo --version "{{ ceph_release }}"
    rm /etc/apt/trusted.gpg.d/ceph.release.gpg || echo "/etc/apt/trusted.gpg.d/ceph.release.gpg not found"
    wget -q -O- 'https://download.ceph.com/keys/release.gpg' | apt-key add -
    apt-get update
    cephadm install ceph-common
  args:
    executable: /bin/bash
  register: install_ceph_common
