---

- name: "cleaning existing deployment"
  shell: |
    docker kill keepalived
    docker rm keepalived
    docker rmi {{ keepalived_docker_image }}
  ignore_errors: yes

- name: "pull an image"
  community.general.docker_image:
    name: "{{ keepalived_docker_image }}"
    source: pull

- name: "deploy container"
  shell: |
    docker run -d --name keepalived --restart=unless-stopped \
      --cap-add=NET_ADMIN --net=host \
      -e KEEPALIVED_PRIORITY="{{ (groups['swarm_mgr'][0] == inventory_hostname) | ternary('200','100') }}" \
      -e KEEPALIVED_VIRTUAL_IPS="{{ homecloud_virtual_ip }}" \
      -e KEEPALIVED_UNICAST_PEERS="{{ homecloud_ips_as_strings }}" \
      {{ keepalived_docker_image }}
