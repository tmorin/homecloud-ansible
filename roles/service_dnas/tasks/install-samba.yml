---

- name: Install samba
  become: yes
  package:
    name: samba
    state: present
    force_apt_get: "yes"

- name: Acviate and start smbd.service
  become: yes
  systemd:
    daemon_reload: yes
    name: smbd.service
    enabled: yes
    state: started
  changed_when: false

- name: Stop smbd service
  become: yes
  systemd:
    name: smbd.service
    state: stopped
  changed_when: false

- name: Copy smb.conf
  become: yes
  template:
    src: smb.conf.jinja2
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: 0644

- name: Set samba password
  become: yes
  shell: >
    (pdbedit --user={{ service_dnas_username }} 2>&1 > /dev/null)
    || (echo '{{ service_dnas_username }}'; echo '{{ service_dnas_username }}')
    | smbpasswd -s -a {{ service_dnas_username }}
  changed_when: false

- name: Restart smbd.service
  become: yes
  service:
    name: smbd.service
    state: restarted
  changed_when: false
