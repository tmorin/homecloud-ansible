---

- name: "get {{ image_armbian_base_archive_path }} stat"
  delegate_to: localhost
  stat:
    path: "{{ image_armbian_base_archive_path }}"
  register: downloaded_armbian_archive_file

- name: "get {{ image_armbian_base_image_path }} stat"
  delegate_to: localhost
  stat:
    path: "{{ image_armbian_base_image_path }}"
  register: unpacked_armbian_image_file

- name: 'fetch armbian image'
  delegate_to: localhost
  when: not downloaded_armbian_archive_file.stat.exists and not unpacked_armbian_image_file.stat.exists
  get_url:
    url: "{{ image_armbian_image_url }}"
    dest: "{{ image_armbian_base_archive_path }}"
    force: false

- name: 'unpack armbian archive'
  delegate_to: localhost
  when: not unpacked_armbian_image_file.stat.exists
  shell:
    chdir: "{{ image_armbian_working_directory }}"
    cmd: |
      archName="{{ image_armbian_archive_name }}"
      ext=${archName##*.}
      case "$ext" in
        "xz")
          unxz {{ image_armbian_base_archive_path }}
          ;;
        "7z")
          7z x -y {{ image_armbian_base_archive_path }}
          ;;
      esac
  register: unpack
- debug: var=unpack